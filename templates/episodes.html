{% extends "base.html" %}
{% block title %}Episodes â€“ {{ series_title }}{% endblock %}

{% block content %}
  <h1 class="mb-4">ğŸï¸ Episodes in {{ series_title }}</h1>
  <a href="{{ url_for('index') }}" class="btn btn-outline-light mb-3">â† Back to series</a>

  {# â”€â”€â”€ Status Filter Pills â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  <ul class="nav nav-pills mb-3" id="filterTabs">
    <li class="nav-item"><a class="nav-link active" data-filter="all" href="#">All</a></li>
    <li class="nav-item"><a class="nav-link" data-filter="matched" href="#">Matched</a></li>
    <li class="nav-item"><a class="nav-link" data-filter="problematic-episode" href="#">Mismatched</a></li>
    <li class="nav-item"><a class="nav-link" data-filter="override" href="#">Overridden</a></li>
  </ul>

  {# â”€â”€â”€ Search + Confidence Slider â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  <div class="row mb-4 align-items-center">
    <div class="col-md-6">
      <input id="searchInput" type="text" class="form-control" placeholder="Search by code or titleâ€¦">
    </div>
    <div class="col-md-6 d-flex justify-content-end">
      <div class="w-50">
        <label for="confSlider" class="form-label mb-1">
          Min Confidence: <span id="confValue">0.00</span>
        </label>
        <input id="confSlider" type="range" class="form-range" min="0" max="1" step="0.01" value="0">
      </div>
    </div>
  </div>

  {# â”€â”€â”€ Dropdown Tables by Season â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ #}
  {% for season, eps in seasons.items() %}
    {% set total    = eps|length %}
    {% set matched  = eps|selectattr('tags','match','(^|,)matched(,|$)')|list|length %}
    {% set mis      = eps|selectattr('tags','match','(^|,)problematic-episode(,|$)')|list|length %}
    {% set overr    = eps|selectattr('tags','match','(^|,)override(,|$)')|list|length %}
    {% set avg_conf = (eps|sum(attribute='confidence')/total)|round(2) %}

    <div class="dropdown mb-3 w-100">
      <button
        class="btn btn-secondary dropdown-toggle w-100 text-start d-flex justify-content-between align-items-center"
        type="button"
        id="dropdownSeason{{season}}"
        data-bs-toggle="dropdown"
        aria-expanded="false"
      >
        <span>
          Season {{season}} â€¢ Episodes: {{total}} â€¢
          âœ… {{matched}} â€¢ âŒ {{mis}} â€¢ âœ± {{overr}} â€¢ Avg Conf: {{avg_conf}}
        </span>
        <span class="d-flex">
          <button
            class="btn btn-success btn-sm ms-2 bulk-override-season"
            data-season="{{season}}"
            title="Bulk Override"
          ><i class="bi bi-shield-check"></i></button>
          <button
            class="btn btn-warning btn-sm ms-1 bulk-autofix-season"
            data-season="{{season}}"
            title="Bulk Auto-Fix"
          ><i class="bi bi-tools"></i></button>
        </span>
      </button>
      <div
        class="dropdown-menu dropdown-menu-dark p-3 w-100"
        aria-labelledby="dropdownSeason{{season}}"
      >
        <div class="table-responsive">
          <table class="table table-dark table-bordered align-middle mb-0">
            <thead>
              <tr>
                <th>Status</th>
                <th>Code</th>
                <th>Expected Title</th>
                <th>Actual Title</th>
                <th>Confidence</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for ep in eps %}
                {% set tag_list = ep.tags.split(',') if ep.tags else [] %}
                <tr
                  data-tags="{{ ep.tags }}"
                  data-sonarr-id="{{ ep.sonarr_id or '' }}"
                  data-key="{{ ep.key }}"
                >
                  <td class="text-center">
                    {% if 'matched' in tag_list %}
                      <i class="bi bi-check-circle-fill text-success"></i>
                    {% elif 'problematic-episode' in tag_list %}
                      <i class="bi bi-exclamation-circle-fill text-danger"></i>
                    {% else %}
                      <i class="bi bi-question-circle-fill text-secondary"></i>
                    {% endif %}
                  </td>
                  <td>{{ ep.code }}</td>
                  <td>
                    <a href="{{ url_for('episode_details', series_id=series_id, key=ep.key) }}">
                      {{ ep.expected_title }}
                    </a>
                  </td>
                  <td>{{ ep.actual_title }}</td>
                  <td>{{ ep.confidence }}{% if 'override' in tag_list %}*{% endif %}</td>
                  <td>
                    {% if 'problematic-episode' in tag_list %}
                      <div class="btn-group" role="group">
                        {% if ep.sonarr_id %}
                          <button
                            class="btn btn-warning btn-sm auto-fix-btn"
                            data-series-id="{{ series_id }}"
                            data-episode-id="{{ ep.sonarr_id }}"
                            title="Auto-Fix via Sonarr"
                          >
                            <i class="bi bi-tools"></i>
                          </button>
                        {% else %}
                          <button class="btn btn-warning btn-sm" disabled title="No Sonarr ID">
                            <i class="bi bi-tools"></i>
                          </button>
                        {% endif %}
                        <form method="POST"
                              action="{{ url_for('override_episode') }}"
                              class="m-0 p-0">
                          <input type="hidden" name="key" value="{{ ep.key }}">
                          <button type="submit" class="btn btn-success btn-sm" title="Override">
                            <i class="bi bi-shield-check"></i>
                          </button>
                        </form>
                      </div>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  {% endfor %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener("DOMContentLoaded", () => {
  // â”€â”€â”€ Auto-Fix button code â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.querySelectorAll(".auto-fix-btn").forEach(btn => {
    btn.addEventListener("click", async (ev) => {
      ev.preventDefault();
      const seriesId  = btn.dataset.seriesId;
      const episodeId = btn.dataset.episodeId;

      // Disable this button & show spinner
      btn.disabled = true;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

      try {
        const resp = await fetch(
          `/series/${seriesId}/episode/auto-fix`,
          {
            method:  "POST",
            headers: { "Content-Type": "application/json" },
            body:    JSON.stringify({ episode_id: episodeId })
          }
        );
        const data = await resp.json();
        if (!resp.ok || data.status !== "success") {
          throw new Error(data.message || "Auto-Fix failed");
        }
        btn.innerHTML = '<i class="bi bi-check-circle-fill"></i> Done';
        setTimeout(() => window.location.reload(), 1000);
      }
      catch(err) {
        console.error(err);
        btn.disabled  = false;
        btn.innerHTML = '<i class="bi bi-tools"></i> Auto-Fix';
        alert("Auto-Fix error: " + err.message);
      }
    });
  });

  // â”€â”€â”€ Purge button code â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const purgeBtn = document.getElementById("purge-btn");
  if (purgeBtn) {
    purgeBtn.addEventListener("click", async (ev) => {
      ev.preventDefault();
      const url = purgeBtn.dataset.url;

      // Disable and show spinner
      purgeBtn.disabled = true;
      purgeBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Purgingâ€¦';

      try {
        const resp = await fetch(url, { method: "POST" });
        const data = await resp.json();
        if (!resp.ok || data.status !== "success") {
          throw new Error(data.message || "Purge failed");
        }
        // On success, show â€œDoneâ€ then reload after a short delay:
        purgeBtn.innerHTML = '<i class="bi bi-check-circle-fill"></i> Done';
        setTimeout(() => window.location.reload(), 1000);
      }
      catch(err) {
        console.error(err);
        purgeBtn.disabled   = false;
        purgeBtn.innerHTML  = '<i class="bi bi-arrow-clockwise"></i> Purge';
        alert("Purge error: " + err.message);
      }
    });
  }
});
</script>
{% endblock %}
