{% extends "base.html" %}
{% block title %}Episodes ‚Äì {{ series_title }}{% endblock %}

{% block content %}
  <h1 class="mb-4">üéûÔ∏è Episodes in {{ series_title }}</h1>
  <a href="{{ url_for('index') }}" class="btn btn-outline-light mb-3">‚Üê Back to series</a>

  {% for season, eps in seasons.items() %}
    <h2 class="mt-5 mb-3">Season {{ season }}</h2>
    <table class="table table-dark table-striped table-bordered align-middle">
      <thead>
        <tr>
          <th>Status</th>
          <th>Code</th>
          <th>Expected Title</th>
          <th>Actual Title</th>
          <th>Confidence</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for ep in eps %}
          <tr>
            <td class="text-center">
              {% set tag_list = ep.tags.split(',') if ep.tags else [] %}
              {% if 'matched' in tag_list %}
                <i class="bi bi-check-circle-fill text-success"></i>
              {% elif 'problematic-episode' in tag_list %}
                <i class="bi bi-exclamation-circle-fill text-danger"></i>
              {% else %}
                <i class="bi bi-question-circle-fill text-secondary"></i>
              {% endif %}
            </td>
            <td>{{ ep.code }}</td>
            <td>{{ ep.expected_title }}</td>
            <td>{{ ep.actual_title }}</td>
            <td>{{ ep.confidence }}</td>
            <td>
              {% if 'problematic-episode' in tag_list and ep.sonarr_id %}
                <form
                  action="{{ url_for('auto_fix', series_id=series_id) }}"
                  method="post"
                  class="d-inline"
                >
                  <!-- EXACT numeric Sonarr ID; no code parsing downstream -->
                  <input
                    type="hidden"
                    name="episode_id"
                    value="{{ ep.sonarr_id }}"
                  >
                  <button type="submit" class="btn btn-sm btn-warning">
                    <i class="bi bi-tools"></i> Auto-Fix
                  </button>
                </form>
              {% elif 'problematic-episode' in tag_list and not ep.sonarr_id %}
                <span class="text-warning small">No Sonarr ID</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% endfor %}
{% endblock %}
